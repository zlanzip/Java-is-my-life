
### Redis持久化

#### redis全量持久化

触发持久化操作的时候，redis会把触发时刻的所有状态的数据生成快照snapshpt,完全保存下来;当redis重启的时候，读最新的一份快照

写入过程

SAVE:客户端触发操作，串行执行（其他所有命令不会并发执行）
BGSAVE；客户端可以触发，可以配置定时任务(配置一定的逻辑)触发，也可以有slave节点触发。单独开一个线程并发执行持久化操
作。持久化的数据是开线程时的状态，会复制出一个副本，副本在整个过程中是不会变的。不影响redis的其他命令操作

BGSAVE相对于SAVE，redis可以在持久化过程中持续提供数据读写服务，但是需要保证Redis服务器的空闲内存足够

恢复流程
rdbLoad()方法


#### redis增量持久化
AOF持久化已日志的形式记录服务器所处处理的每一个写和删除操作。
有3中同步策略：每秒同步、每修改同步、不同步

#### Redis 4.0 对于持久化机制的优化

Redis 4.0 开始支持 RDB 和 AOF 的混合持久化（默认关闭，可以通过配置项 aof-use-rdb-preamble 开启）。

如果把混合持久化打开，AOF 重写的时候就直接把 RDB 的内容写到 AOF 文件开头。这样做的好处是可以结合 RDB 和 AOF 的优点, 快速加载同时避免丢失过多的数据。当然缺点也是有的， AOF 里面的 RDB 部分是压缩格式不再是 AOF 格式，可读性较差。

补充内容：AOF 重写

AOF重写可以产生一个新的AOF文件，这个新的AOF文件和原有的AOF文件所保存的数据库状态一样，但体积更小。

AOF重写是一个有歧义的名字，该功能是通过读取数据库中的键值对来实现的，程序无须对现有AOF文件进行任伺读入、分析或者写入操作。

在执行 BGREWRITEAOF 命令时，Redis 服务器会维护一个 AOF 重写缓冲区，该缓冲区会在子进程创建新AOF文件期间，记录服务器执行的所有写命令。当子进程完成创建新AOF文件的工作之后，服务器会将重写缓冲区中的所有内容追加到新AOF文件的末尾，使得新旧两个AOF文件所保存的数据库状态一致。最后，服务器用新的AOF文件替换旧的AOF文件，以此来完成AOF文件重写操作

